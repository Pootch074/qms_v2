<main id="main" class="main" style="margin-top: 8vh; overflow:hidden;">
    <div class="container-fluid h-100">
        <div class="row h-100 pt-1" style="background: rgb(12,48,128); background: linear-gradient(180deg, rgba(12,48,128,1) 0%, rgba(28,75,178,1) 82%, rgba(101,130,194,1) 100%);">
            <div class="col-6 text-center border d-flex flex-column">
                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS2W1Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">2</h2>
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">1</h2>
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS2W2Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">2</h2>
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">2</h2>
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS3W1Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            3
                        </h2>
                    </div>


                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            1
                        </h2>
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS3W2Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            3
                        </h2>
                    </div>


                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            2
                        </h2>
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS3W3Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            3
                        </h2>
                    </div>


                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            3
                        </h2>
                    </div>
                </div>
                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS3W4Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            3
                        </h2>
                    </div>


                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            4
                        </h2>
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">

                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS4W1Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            4
                        </h2>
                    </div>


                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            1
                        </h2>
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">

                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS4W2Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            4
                        </h2>
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            2
                        </h2>
                    </div>
                </div>
                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">

                    <div class="h-100 d-flex align-items-center justify-content-center" id="qsdS4W3Prio" style="width:60%;">
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="width:20%;">
                        <h2 class="qsdStepFont">
                            4
                        </h2>
                    </div>

                    <div class="h-100 d-flex align-items-center justify-content-center" style="margin-right:2vw; width:20%;">
                        <h2 class="qsdStepFont">
                            3
                        </h2>
                    </div>
                </div>

            </div>


            <!-- TO BE HIDDEN -->
            <div id="mnbghjk" class="col-6 text-center border d-flex flex-column">
                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS2W1Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="calls2w1" style="width:20%;">
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS2W2Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="calls2w2" style="width:20%;">
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS3W1Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS3W2Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS3W3Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>
                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS3W4Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS4W1Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>

                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS4W2Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>
                <div class="cardCstm flex-grow-1 mb-1 d-flex align-items-center justify-content-center" style="width:100%;">
                    <div class="h-100 d-flex align-items-center justify-content-center" id="hiddenQsdS4W3Prio" style="width:60%;">
                    </div>
                    <div class="h-100 d-flex align-items-center justify-content-center" id="abcdcallCount" style="width:20%;">
                    </div>
                </div>
            </div>
            <!-- TO BE HIDDEN -->


            <div class="col-6 text-center border" style="background: rgb(12,48,128); background: linear-gradient(180deg, rgba(12,48,128,1) 0%, rgba(28,75,178,1) 82%, rgba(101,130,194,1) 100%);">
                <div class="cardCstm flex-grow-1 mb-1 d-flex">
                    <video width="100%" height="auto%" autoplay loop muted>
                        <source src="assets\resources\qsdVideos\vid2.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>

                <div class="card mb-1 d-flex align-items-center">
                    <div class="speech" id="speechID">
                    </div>
                    <div class="clock">
                        <!-- Hours -->
                        <div class="hours">
                            <div class="first">
                                <div class="number">0</div>
                            </div>
                            <div class="second">
                                <div class="number">0</div>
                            </div>
                        </div>
                        <!-- Separator -->
                        <div class="tick">:</div>
                        <!-- Minutes -->
                        <div class="minutes">
                            <div class="first">
                                <div class="number">0</div>
                            </div>
                            <div class="second">
                                <div class="number">0</div>
                            </div>
                        </div>
                        <!-- Separator -->
                        <div class="tick">:</div>
                        <!-- Seconds -->
                        <div class="seconds">
                            <div class="first">
                                <div class="number">0</div>
                            </div>
                            <div class="second infinite">
                                <div class="number">0</div>
                            </div>
                        </div>
                        <!-- AM/PM Indicator -->
                        <div class="am-pm">AM</div>
                    </div>
                    <div id="ww_bfc7f2428757d" v='1.3' loc='id' a='{"t":"responsive","lang":"en","sl_lpl":1,"ids":["wl860"],"font":"Arial","sl_ics":"one_a","sl_sot":"celsius","cl_bkg":"image","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA","cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722","el_wfc":3}'><a href="https://weatherwidget.org/" id="ww_bfc7f2428757d_u" target="_blank">Widget weather</a></div>
                </div>
            </div>

        </div>
    </div>
</main>
<audio id="audioPlayer" src="assets\resources\ascend.mp3"></audio>

<script src="<?= base_url('assets/') ?>plugins/jquery/jquery.minQSD.js"></script>
<script async src="https://app3.weatherwidget.org/js/?id=ww_bfc7f2428757d"></script>
<script>
    const BASE_URL = "<?= base_url() ?>";
</script>
<script defer src="<?= base_url('assets/js/qsdPriority.js') ?>"></script>


<script>
    $(document).ready(function() {
        let prevData = {};
        let queue = [];
        let isSpeaking = false;

        function processQueue() {
            if (queue.length > 0 && !isSpeaking) {
                isSpeaking = true;
                let {
                    message,
                    callback
                } = queue.shift();
                playAudioAndSpeak(message, callback);
            }
        }

        function playAudioAndSpeak(message, callback) {
            const audioPlayer = document.getElementById('audioPlayer');

            audioPlayer.addEventListener('ended', function onEnded() {
                audioPlayer.removeEventListener('ended', onEnded);

                if (!('speechSynthesis' in window)) {
                    console.warn('Speech Synthesis not supported');
                    isSpeaking = false;
                    callback();
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'en-US';
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;

                const setVoiceAndSpeak = () => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 2) utterance.voice = voices[2];
                    speechSynthesis.speak(utterance);
                };

                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.onvoiceschanged = setVoiceAndSpeak;
                } else {
                    setVoiceAndSpeak();
                }

                utterance.onend = () => {
                    console.log('Speech synthesis ended.');
                    isSpeaking = false;
                    callback();
                };

                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                    isSpeaking = false;
                    callback();
                };
            });

            audioPlayer.play();
        }

        function handleQueueData(url, elementID, step, windowNum = null) {
            $.get(url, function(data) {
                $(elementID).html(data);

                const h1 = $(elementID + ' h1');
                if (!h1.length) return;

                const rawText = h1.text().trim();
                if (!rawText) return;

                // Extract queue number like "P 000", "A 005", etc.
                const queueNum = rawText;

                // Normalize queue number by removing all non-digits (e.g. "P 000" → "000")
                const normalizedQueueNum = queueNum.replace(/[^\d]/g, '');

                if (parseInt(normalizedQueueNum, 10) === 0) {
                    console.log(`Skipped audio/speech for queue number ${queueNum}`);
                    return;
                }

                if (!prevData[url]) prevData[url] = {
                    queueNum: null
                };

                const changed = queueNum !== prevData[url].queueNum;
                if (!changed) {
                    $(elementID).removeClass('elementID');
                    return;
                }

                prevData[url] = {
                    queueNum
                };
                $(elementID).addClass('elementID');

                const baseMsg = `Client number, ${queueNum}. Please proceed to step ${step}`;
                const fullMessage = windowNum ?
                    `${baseMsg} window ${windowNum}. ${queueNum}, to step ${step} window ${windowNum}.` :
                    `${baseMsg}. ${queueNum}, to step ${step}.`;

                console.log(`New message: ${fullMessage}`);
                queue.push({
                    message: fullMessage,
                    callback: processQueue
                });
                processQueue();
            }).fail(function(xhr, status, error) {
                console.error("Error fetching queue data:", error);
            });
        }



        function qsdLoadStepFlow() {
            handleQueueData('<?= base_url('qsdS2W1PrioRou') ?>', '#qsdS2W1Prio', 2, 1);
            handleQueueData('<?= base_url('qsdS2W2PrioRou') ?>', '#qsdS2W2Prio', 2, 2);

            handleQueueData('<?= base_url('qsdS3W1PrioRou') ?>', '#qsdS3W1Prio', 3, 1);
            handleQueueData('<?= base_url('qsdS3W2PrioRou') ?>', '#qsdS3W2Prio', 3, 2);
            handleQueueData('<?= base_url('qsdS3W3PrioRou') ?>', '#qsdS3W3Prio', 3, 3);
            handleQueueData('<?= base_url('qsdS3W4PrioRou') ?>', '#qsdS3W4Prio', 3, 4);

            handleQueueData('<?= base_url('qsdS4W1PrioRou') ?>', '#qsdS4W1Prio', 4, 1);
            handleQueueData('<?= base_url('qsdS4W2PrioRou') ?>', '#qsdS4W2Prio', 4, 2);
            handleQueueData('<?= base_url('qsdS4W3PrioRou') ?>', '#qsdS4W3Prio', 4, 3);
        }

        function qsdLoadStepFlowWithDelay() {
            qsdLoadStepFlow();
            setTimeout(qsdLoadStepFlowWithDelay, 500); // Adjust as needed
        }

        qsdLoadStepFlowWithDelay();
    });
</script>

<script>
    // FOR FETCHING VALUE OF call_num FROM recall TABLE
    $(document).ready(function() {
        callCount();
        setInterval(callCount, 500);
    });

    function callCount() {
        const endpoints = [{
                url: '<?= base_url('calls2w1Rou') ?>',
                target: '#calls2w1'
            },
            {
                url: '<?= base_url('calls2w2Rou') ?>',
                target: '#calls2w2'
            },
        ];

        endpoints.forEach(({
            url,
            target
        }) => {
            $.get(url)
                .done(function(data) {
                    $(target).html(data);
                })
                .fail(function(xhr, status, error) {
                    console.error(`Error loading ${url}:`, error);
                });
        });
    }
</script>